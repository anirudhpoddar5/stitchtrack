<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>StitchTrack Pro</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.45.4/dist/umd/supabase.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<style>
:root{
  --navy:#1E3A5F;--blue:#2563A8;--cyan:#0EA5E9;
  --green:#10B981;--amber:#F59E0B;--orange:#F97316;--red:#EF4444;--purple:#8B5CF6;
  --bg:#F0F4F8;--surface:#fff;--border:#E2E8F0;
  --text:#1E293B;--text2:#64748B;--text3:#94A3B8;
  --sidebar:240px;
}
*{box-sizing:border-box;margin:0;padding:0;}
body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',sans-serif;background:var(--bg);color:var(--text);min-height:100vh;display:flex;}

/* SIDEBAR */
.sidebar{width:var(--sidebar);background:var(--navy);display:flex;flex-direction:column;position:fixed;top:0;left:0;height:100vh;z-index:200;transition:transform .3s;}
.sidebar-brand{padding:20px 16px 16px;border-bottom:1px solid rgba(255,255,255,.1);}
.sidebar-brand h1{color:#fff;font-size:1.2rem;font-weight:700;}
.sidebar-brand h1 span{color:var(--cyan);}
.sidebar-brand p{color:var(--text3);font-size:.7rem;margin-top:2px;}
.sidebar-nav{flex:1;overflow-y:auto;padding:12px 0;}
.nav-section{color:var(--text3);font-size:.65rem;font-weight:700;letter-spacing:.08em;text-transform:uppercase;padding:10px 16px 4px;}
.nav-item{display:flex;align-items:center;gap:10px;padding:10px 16px;color:rgba(255,255,255,.65);cursor:pointer;transition:.15s;border-left:3px solid transparent;font-size:.875rem;}
.nav-item:hover{background:rgba(255,255,255,.08);color:#fff;}
.nav-item.active{background:rgba(37,99,168,.3);color:#fff;border-left-color:var(--cyan);}
.nav-item i{width:18px;text-align:center;}
.sidebar-footer{padding:12px 16px;border-top:1px solid rgba(255,255,255,.1);color:var(--text3);font-size:.7rem;text-align:center;}

/* MAIN */
.main{margin-left:var(--sidebar);flex:1;display:flex;flex-direction:column;min-height:100vh;}
.topbar{background:var(--surface);border-bottom:1px solid var(--border);padding:0 24px;height:60px;display:flex;align-items:center;justify-content:space-between;position:sticky;top:0;z-index:100;}
.topbar-left{display:flex;align-items:center;gap:12px;}
.hamburger{display:none;background:none;border:none;cursor:pointer;font-size:1.2rem;color:var(--text);}
.topbar h2{font-size:1rem;font-weight:600;}
.topbar-right{display:flex;gap:8px;}
.content{padding:24px;flex:1;}

/* PAGES */
.page{display:none;} .page.active{display:block;}

/* BUTTONS */
.btn{display:inline-flex;align-items:center;gap:6px;padding:8px 16px;border-radius:6px;font-size:.875rem;font-weight:500;cursor:pointer;border:none;transition:.15s;font-family:inherit;}
.btn-primary{background:var(--blue);color:#fff;} .btn-primary:hover{background:#1d4ed8;}
.btn-success{background:var(--green);color:#fff;} .btn-success:hover{background:#059669;}
.btn-danger{background:#fee2e2;color:var(--red);border:1px solid #fecaca;} .btn-danger:hover{background:#fecaca;}
.btn-secondary{background:var(--bg);color:var(--text);border:1px solid var(--border);} .btn-secondary:hover{background:var(--border);}
.btn-sm{padding:5px 10px;font-size:.8rem;}
.btn-icon{padding:6px 8px;border-radius:5px;background:var(--bg);border:1px solid var(--border);cursor:pointer;color:var(--text2);transition:.15s;} .btn-icon:hover{background:var(--border);}

/* CARDS */
.card{background:var(--surface);border-radius:10px;border:1px solid var(--border);}
.card-header{display:flex;align-items:center;justify-content:space-between;padding:16px 20px;border-bottom:1px solid var(--border);}
.card-title{font-size:.9375rem;font-weight:600;display:flex;align-items:center;gap:8px;}
.card-body{padding:20px;}

/* STATS */
.stats-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:16px;margin-bottom:20px;}
.stat-card{background:var(--surface);border-radius:10px;border:1px solid var(--border);padding:20px;display:flex;align-items:center;gap:16px;}
.stat-icon{width:48px;height:48px;border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:1.25rem;flex-shrink:0;}
.stat-info h3{font-size:1.75rem;font-weight:700;}
.stat-info p{font-size:.8rem;color:var(--text2);margin-top:2px;}

/* TABLES */
.table-wrap{background:var(--surface);border-radius:10px;border:1px solid var(--border);overflow:hidden;}
.table-header{display:flex;align-items:center;justify-content:space-between;padding:14px 20px;border-bottom:1px solid var(--border);flex-wrap:wrap;gap:10px;}
.table-filters{display:flex;gap:8px;align-items:center;flex-wrap:wrap;}
.search-box{display:flex;align-items:center;gap:6px;background:var(--bg);border:1px solid var(--border);border-radius:6px;padding:6px 12px;}
.search-box input{border:none;background:none;outline:none;font-size:.875rem;width:180px;color:var(--text);}
.search-box input::placeholder{color:var(--text3);}
select.filter{padding:6px 10px;border:1px solid var(--border);border-radius:6px;font-size:.8rem;background:var(--surface);color:var(--text);cursor:pointer;}
.table-container{overflow-x:auto;}
table{width:100%;border-collapse:collapse;}
th{text-align:left;padding:11px 16px;font-size:.75rem;font-weight:600;color:var(--text2);text-transform:uppercase;letter-spacing:.04em;background:var(--bg);border-bottom:1px solid var(--border);}
td{padding:11px 16px;font-size:.875rem;border-bottom:1px solid var(--border);vertical-align:middle;}
tr:last-child td{border-bottom:none;}
tr:hover td{background:#fafbfc;}
.actions-cell{display:flex;gap:6px;}

/* BADGES */
.badge{display:inline-flex;align-items:center;padding:3px 10px;border-radius:20px;font-size:.73rem;font-weight:600;white-space:nowrap;}
.badge-active,.badge-completed,.badge-green{background:#d1fae5;color:#065f46;}
.badge-repair,.badge-open,.badge-red{background:#fee2e2;color:#991b1b;}
.badge-awaiting,.badge-amber{background:#fef3c7;color:#92400e;}
.badge-external,.badge-purple{background:#ede9fe;color:#5b21b6;}
.badge-condemned,.badge-gray{background:#f1f5f9;color:#475569;}
.badge-inprogress,.badge-blue{background:#dbeafe;color:#1e40af;}
.badge-agency,.badge-orange{background:#ffedd5;color:#9a3412;}

/* MODAL */
.modal-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,.5);z-index:1000;align-items:center;justify-content:center;padding:16px;}
.modal-overlay.open{display:flex;}
.modal{background:var(--surface);border-radius:12px;width:100%;max-width:640px;max-height:92vh;overflow-y:auto;box-shadow:0 20px 60px rgba(0,0,0,.3);}
.modal.modal-lg{max-width:800px;}
.modal-header{display:flex;align-items:center;justify-content:space-between;padding:20px 24px;border-bottom:1px solid var(--border);position:sticky;top:0;background:var(--surface);z-index:10;}
.modal-title{font-size:1rem;font-weight:600;}
.modal-close{background:none;border:none;cursor:pointer;color:var(--text2);font-size:1.1rem;padding:4px;border-radius:4px;} .modal-close:hover{color:var(--text);background:var(--bg);}
.modal-body{padding:24px;}
.modal-footer{display:flex;justify-content:flex-end;gap:10px;padding:16px 24px;border-top:1px solid var(--border);}

/* FORMS */
.form-grid{display:grid;grid-template-columns:1fr 1fr;gap:16px;}
.form-group{display:flex;flex-direction:column;gap:5px;}
.form-group.span2{grid-column:span 2;}
label{font-size:.8rem;font-weight:500;color:var(--text2);}
input,select,textarea{padding:9px 12px;border:1px solid var(--border);border-radius:6px;font-size:.875rem;color:var(--text);background:var(--surface);outline:none;transition:.15s;font-family:inherit;width:100%;}
input:focus,select:focus,textarea:focus{border-color:var(--blue);box-shadow:0 0 0 3px rgba(37,99,168,.1);}
textarea{resize:vertical;min-height:70px;}
.radio-group{display:flex;gap:16px;}
.radio-group label{display:flex;align-items:center;gap:6px;cursor:pointer;font-weight:400;color:var(--text);}
.parts-row{display:grid;grid-template-columns:1fr 1fr auto;gap:8px;align-items:center;margin-bottom:8px;}
.parts-header{display:grid;grid-template-columns:1fr 1fr auto;gap:8px;margin-bottom:4px;}
.parts-header span{font-size:.75rem;font-weight:600;color:var(--text2);text-transform:uppercase;}

/* TIMELINE */
.timeline{display:flex;flex-direction:column;gap:0;}
.timeline-item{display:flex;gap:16px;padding:16px 0;border-bottom:1px solid var(--border);}
.timeline-item:last-child{border-bottom:none;}
.timeline-icon{width:36px;height:36px;border-radius:50%;display:flex;align-items:center;justify-content:center;flex-shrink:0;font-size:.9rem;}
.timeline-content{flex:1;}
.timeline-date{font-size:.75rem;color:var(--text3);margin-bottom:4px;}
.timeline-title{font-weight:600;font-size:.9rem;margin-bottom:4px;}
.timeline-detail{font-size:.8125rem;color:var(--text2);}

/* TOAST */
.toast{position:fixed;bottom:20px;right:20px;background:var(--navy);color:#fff;padding:12px 20px;border-radius:8px;font-size:.875rem;z-index:9999;display:flex;align-items:center;gap:10px;box-shadow:0 4px 20px rgba(0,0,0,.3);transform:translateY(80px);transition:transform .3s;max-width:360px;}
.toast.show{transform:translateY(0);}
.toast.success{background:#065f46;} .toast.error{background:#991b1b;}

/* LOADING */
.loader{position:fixed;inset:0;background:rgba(255,255,255,.8);z-index:9998;display:none;align-items:center;justify-content:center;}
.loader.show{display:flex;}
.spinner{width:40px;height:40px;border:4px solid var(--border);border-top-color:var(--blue);border-radius:50%;animation:spin .8s linear infinite;}
@keyframes spin{to{transform:rotate(360deg);}}

/* EMPTY STATE */
.empty{text-align:center;padding:48px 24px;color:var(--text2);}
.empty i{font-size:2.5rem;color:var(--text3);margin-bottom:12px;display:block;}
.empty h3{font-size:1rem;font-weight:600;margin-bottom:6px;color:var(--text);}

/* TABS */
.tabs{display:flex;gap:4px;background:var(--bg);padding:4px;border-radius:8px;margin-bottom:20px;flex-wrap:wrap;}
.tab{padding:7px 14px;border-radius:6px;cursor:pointer;font-size:.8125rem;font-weight:500;color:var(--text2);border:none;background:none;transition:.15s;}
.tab:hover{background:rgba(0,0,0,.05);}
.tab.active{background:var(--surface);color:var(--text);box-shadow:0 1px 3px rgba(0,0,0,.1);}
.tab-content{display:none;} .tab-content.active{display:block;}

/* CHARTS GRID */
.charts-grid{display:grid;grid-template-columns:300px 1fr;gap:16px;margin-bottom:20px;}
.chart-card{background:var(--surface);border-radius:10px;border:1px solid var(--border);padding:20px;}
.chart-card h3{font-size:.875rem;font-weight:600;margin-bottom:16px;color:var(--text2);text-transform:uppercase;letter-spacing:.04em;}

/* PAGE HEADER */
.page-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:20px;gap:12px;flex-wrap:wrap;}
.page-header h2{font-size:1.25rem;font-weight:700;}
.page-header p{font-size:.875rem;color:var(--text2);}

/* CONNECTION ERROR */
.conn-error{background:#fee2e2;border:1px solid #fecaca;color:#991b1b;padding:16px 20px;border-radius:8px;margin-bottom:20px;display:none;}

/* GRID 2 */
.grid2{display:grid;grid-template-columns:1fr 1fr;gap:16px;}

/* MOBILE */
@media(max-width:768px){
  .sidebar{transform:translateX(-100%);}
  .sidebar.open{transform:translateX(0);}
  .main{margin-left:0;}
  .hamburger{display:block;}
  .form-grid{grid-template-columns:1fr;}
  .form-group.span2{grid-column:span 1;}
  .charts-grid{grid-template-columns:1fr;}
  .grid2{grid-template-columns:1fr;}
  .stats-grid{grid-template-columns:1fr 1fr;}
  .content{padding:16px;}
  .table-filters{width:100%;}
}
@media(max-width:480px){.stats-grid{grid-template-columns:1fr;}}

/* PRINT */
@media print{
  .sidebar,.topbar,.topbar-right,.btn,.actions-cell,.table-filters{display:none!important;}
  .main{margin-left:0;}
  .card,.table-wrap{border:1px solid #ccc;box-shadow:none;}
  body{background:#fff;}
}
</style>
</head>
<body>

<!-- SIDEBAR -->
<aside class="sidebar" id="sidebar">
  <div class="sidebar-brand">
    <h1><i class="fas fa-spool" style="color:var(--cyan);margin-right:8px;"></i>Stitch<span>Track</span></h1>
    <p>Maintenance & Repair Pro</p>
  </div>
  <nav class="sidebar-nav">
    <div class="nav-section">Overview</div>
    <div class="nav-item active" onclick="nav('dashboard')"><i class="fas fa-gauge-high"></i><span>Dashboard</span></div>
    <div class="nav-section">Management</div>
    <div class="nav-item" onclick="nav('masters')"><i class="fas fa-sliders"></i><span>Masters / Setup</span></div>
    <div class="nav-item" onclick="nav('machines')"><i class="fas fa-industry"></i><span>Machine Registry</span></div>
    <div class="nav-item" onclick="nav('repairs')"><i class="fas fa-wrench"></i><span>Repair Log</span></div>
    <div class="nav-item" onclick="nav('maintenance')"><i class="fas fa-calendar-check"></i><span>Maintenance Log</span></div>
    <div class="nav-section">Insights</div>
    <div class="nav-item" onclick="nav('reports')"><i class="fas fa-chart-bar"></i><span>Reports</span></div>
  </nav>
  <div class="sidebar-footer">StitchTrack Pro v1.0</div>
</aside>

<!-- MAIN -->
<div class="main">
  <header class="topbar">
    <div class="topbar-left">
      <button class="hamburger" onclick="toggleSidebar()"><i class="fas fa-bars"></i></button>
      <h2 id="page-title">Dashboard</h2>
    </div>
    <div class="topbar-right" id="topbar-actions"></div>
  </header>

  <div class="content">
    <div class="conn-error" id="conn-error"></div>

    <!-- DASHBOARD -->
    <div class="page active" id="page-dashboard">
      <div class="stats-grid">
        <div class="stat-card"><div class="stat-icon" style="background:#dbeafe"><i class="fas fa-industry" style="color:var(--blue)"></i></div><div class="stat-info"><h3 id="s-total">–</h3><p>Total Machines</p></div></div>
        <div class="stat-card"><div class="stat-icon" style="background:#d1fae5"><i class="fas fa-circle-check" style="color:var(--green)"></i></div><div class="stat-info"><h3 id="s-active">–</h3><p>Active Machines</p></div></div>
        <div class="stat-card"><div class="stat-icon" style="background:#fee2e2"><i class="fas fa-triangle-exclamation" style="color:var(--red)"></i></div><div class="stat-info"><h3 id="s-open">–</h3><p>Open Repairs</p></div></div>
        <div class="stat-card"><div class="stat-icon" style="background:#fef3c7"><i class="fas fa-clock" style="color:var(--amber)"></i></div><div class="stat-info"><h3 id="s-stale">–</h3><p>Stale Repairs (&gt;3 days)</p></div></div>
      </div>
      <div class="charts-grid">
        <div class="chart-card"><h3>Machine Status</h3><canvas id="status-chart"></canvas></div>
        <div class="chart-card"><h3>Open Repairs</h3><div id="open-repairs-list"><div class="empty"><i class="fas fa-check-circle"></i><h3>No open repairs</h3></div></div></div>
      </div>
      <div class="grid2">
        <div class="card"><div class="card-header"><div class="card-title"><i class="fas fa-fire" style="color:var(--red)"></i>Top Problem Machines (30 days)</div></div><div id="problem-machines" style="padding:16px;"><div class="empty"><i class="fas fa-cog"></i><h3>No data yet</h3></div></div></div>
        <div class="card"><div class="card-header"><div class="card-title"><i class="fas fa-truck" style="color:var(--purple)"></i>Sent to External Agency</div></div><div id="external-list" style="padding:16px;"><div class="empty"><i class="fas fa-check"></i><h3>None sent out</h3></div></div></div>
      </div>
    </div>

    <!-- MASTERS -->
    <div class="page" id="page-masters">
      <div class="tabs" id="master-tabs"></div>
      <div id="master-tab-contents"></div>
    </div>

    <!-- MACHINES -->
    <div class="page" id="page-machines">
      <div class="table-wrap">
        <div class="table-header">
          <span style="font-weight:600">All Machines</span>
          <div class="table-filters">
            <div class="search-box"><i class="fas fa-search" style="color:var(--text3)"></i><input type="text" placeholder="Search machine no..." id="machine-search" oninput="renderMachines()"></div>
            <select class="filter" id="machine-floor-filter" onchange="renderMachines()"><option value="">All Floors</option></select>
            <select class="filter" id="machine-status-filter" onchange="renderMachines()">
              <option value="">All Status</option>
              <option>Active</option><option>Under Repair</option><option>Awaiting Parts</option><option>Sent for External Repair</option><option>Condemned</option>
            </select>
            <label style="display:flex;align-items:center;gap:6px;font-size:.8rem;cursor:pointer;font-weight:400">
              <input type="file" id="import-file" accept=".xlsx,.xls" style="display:none" onchange="handleImport(this)">
              <button class="btn btn-secondary btn-sm" onclick="document.getElementById('import-file').click()"><i class="fas fa-file-excel"></i> Import Excel</button>
            </label>
          </div>
        </div>
        <div class="table-container">
          <table><thead><tr><th>Machine No.</th><th>Brand</th><th>Type</th><th>Floor</th><th>Line</th><th>Purchase Date</th><th>Status</th><th>Actions</th></tr></thead>
          <tbody id="machines-tbody"></tbody></table>
        </div>
      </div>
    </div>

    <!-- MACHINE HISTORY -->
    <div class="page" id="page-history">
      <div style="margin-bottom:16px;"><button class="btn btn-secondary" onclick="nav('machines')"><i class="fas fa-arrow-left"></i> Back</button></div>
      <div class="card" id="history-machine-card" style="margin-bottom:20px;padding:20px;"></div>
      <div class="card">
        <div class="card-header"><div class="card-title"><i class="fas fa-clock-rotate-left"></i> Full Machine History</div><button class="btn btn-secondary btn-sm" onclick="window.print()"><i class="fas fa-print"></i> Print</button></div>
        <div class="card-body"><div class="timeline" id="history-timeline"></div></div>
      </div>
    </div>

    <!-- REPAIRS -->
    <div class="page" id="page-repairs">
      <div class="table-wrap">
        <div class="table-header">
          <span style="font-weight:600">Repair Log</span>
          <div class="table-filters">
            <div class="search-box"><i class="fas fa-search" style="color:var(--text3)"></i><input type="text" placeholder="Machine no..." id="repair-search" oninput="renderRepairs()"></div>
            <select class="filter" id="repair-status-filter" onchange="renderRepairs()"><option value="">All Status</option><option>Open</option><option>In Progress</option><option>Awaiting Parts</option><option>Sent to External Agency</option><option>Completed</option></select>
            <input type="date" class="filter" id="repair-date-from" onchange="renderRepairs()" title="From date">
            <input type="date" class="filter" id="repair-date-to" onchange="renderRepairs()" title="To date">
          </div>
        </div>
        <div class="table-container">
          <table><thead><tr><th>Machine</th><th>Date</th><th>Problem</th><th>Type</th><th>By</th><th>Status</th><th>Actions</th></tr></thead>
          <tbody id="repairs-tbody"></tbody></table>
        </div>
      </div>
    </div>

    <!-- MAINTENANCE -->
    <div class="page" id="page-maintenance">
      <div class="table-wrap">
        <div class="table-header">
          <span style="font-weight:600">Maintenance Log</span>
          <div class="table-filters">
            <select class="filter" id="maint-mode-filter" onchange="renderMaintenance()"><option value="">All Modes</option><option value="machine">Per Machine</option><option value="floor_line">Per Floor/Line</option></select>
            <input type="date" class="filter" id="maint-date-from" onchange="renderMaintenance()">
            <input type="date" class="filter" id="maint-date-to" onchange="renderMaintenance()">
          </div>
        </div>
        <div class="table-container">
          <table><thead><tr><th>Machine / Floor-Line</th><th>Date</th><th>Type</th><th>Technician</th><th>Parts Used</th><th>Actions</th></tr></thead>
          <tbody id="maintenance-tbody"></tbody></table>
        </div>
      </div>
    </div>

    <!-- REPORTS -->
    <div class="page" id="page-reports">
      <div style="display:flex;gap:12px;align-items:center;margin-bottom:16px;flex-wrap:wrap;">
        <label style="display:flex;align-items:center;gap:6px;font-size:.875rem;">From: <input type="date" id="rep-from" style="width:auto"></label>
        <label style="display:flex;align-items:center;gap:6px;font-size:.875rem;">To: <input type="date" id="rep-to" style="width:auto"></label>
        <button class="btn btn-primary btn-sm" onclick="loadReports()"><i class="fas fa-sync"></i> Load</button>
        <button class="btn btn-secondary btn-sm" onclick="window.print()"><i class="fas fa-print"></i> Print</button>
        <button class="btn btn-secondary btn-sm" onclick="exportCurrentReport()"><i class="fas fa-file-excel"></i> Export Excel</button>
      </div>
      <div class="tabs">
        <button class="tab active" onclick="switchReport('rep-repair')">Repair Report</button>
        <button class="tab" onclick="switchReport('rep-maintenance')">Maintenance Report</button>
        <button class="tab" onclick="switchReport('rep-machine-summary')">Machine Summary</button>
        <button class="tab" onclick="switchReport('rep-part-summary')">Part Summary</button>
        <button class="tab" onclick="switchReport('rep-external')">External Repairs</button>
      </div>
      <div id="rep-repair" class="tab-content active"><div class="table-wrap"><div class="table-container"><table><thead><tr><th>Machine</th><th>Date</th><th>Problem</th><th>Complaint</th><th>By</th><th>Parts Used</th><th>Status</th></tr></thead><tbody id="rep-repair-body"></tbody></table></div></div></div>
      <div id="rep-maintenance" class="tab-content"><div class="table-wrap"><div class="table-container"><table><thead><tr><th>Machine/Floor</th><th>Date</th><th>Type</th><th>Technician</th><th>Parts Used</th></tr></thead><tbody id="rep-maint-body"></tbody></table></div></div></div>
      <div id="rep-machine-summary" class="tab-content"><div class="table-wrap"><div class="table-container"><table><thead><tr><th>Machine No.</th><th>Brand</th><th>Floor</th><th>Line</th><th>Repairs</th><th>Maintenance</th></tr></thead><tbody id="rep-machine-body"></tbody></table></div></div></div>
      <div id="rep-part-summary" class="tab-content"><div class="table-wrap"><div class="table-container"><table><thead><tr><th>Part Name</th><th>Unit</th><th>Used in Repairs</th><th>Used in Maintenance</th><th>Total Used</th></tr></thead><tbody id="rep-part-body"></tbody></table></div></div></div>
      <div id="rep-external" class="tab-content"><div class="table-wrap"><div class="table-container"><table><thead><tr><th>Machine</th><th>Agency</th><th>Date Sent</th><th>Expected Return</th><th>Actual Return</th><th>Days Out</th><th>Status</th></tr></thead><tbody id="rep-ext-body"></tbody></table></div></div></div>
    </div>
  </div>
</div>

<!-- MACHINE MODAL -->
<div class="modal-overlay" id="machine-modal">
<div class="modal">
  <div class="modal-header"><span class="modal-title" id="machine-modal-title">Add Machine</span><button class="modal-close" onclick="closeModal('machine-modal')"><i class="fas fa-times"></i></button></div>
  <div class="modal-body">
    <div class="form-grid">
      <div class="form-group"><label>Machine Number *</label><input id="m-number" placeholder="e.g. M001" required></div>
      <div class="form-group"><label>Status</label><select id="m-status"><option>Active</option><option>Under Repair</option><option>Awaiting Parts</option><option>Sent for External Repair</option><option>Condemned</option></select></div>
      <div class="form-group"><label>Brand</label><select id="m-brand"><option value="">Select...</option></select></div>
      <div class="form-group"><label>Machine Type</label><select id="m-type"><option value="">Select...</option></select></div>
      <div class="form-group"><label>Model</label><select id="m-model"><option value="">Select...</option></select></div>
      <div class="form-group"><label>Purchase Date</label><input type="date" id="m-date"></div>
      <div class="form-group"><label>Floor</label><select id="m-floor" onchange="populateLinesInForm('m-line','m-floor')"><option value="">Select...</option></select></div>
      <div class="form-group"><label>Line</label><select id="m-line"><option value="">Select...</option></select></div>
      <div class="form-group span2"><label>Notes</label><textarea id="m-notes" rows="2"></textarea></div>
    </div>
  </div>
  <div class="modal-footer">
    <button class="btn btn-secondary" onclick="closeModal('machine-modal')">Cancel</button>
    <button class="btn btn-primary" onclick="saveMachine()">Save Machine</button>
  </div>
</div>
</div>

<!-- CONDEMN MODAL -->
<div class="modal-overlay" id="condemn-modal">
<div class="modal">
  <div class="modal-header"><span class="modal-title">Condemn Machine</span><button class="modal-close" onclick="closeModal('condemn-modal')"><i class="fas fa-times"></i></button></div>
  <div class="modal-body">
    <p style="margin-bottom:16px;color:var(--text2);">This action marks the machine as permanently out of service. Please provide the reason.</p>
    <input type="hidden" id="condemn-id">
    <div class="form-group" style="margin-bottom:16px;"><label>Condemnation Date *</label><input type="date" id="condemn-date"></div>
    <div class="form-group"><label>Reason *</label><textarea id="condemn-reason" placeholder="e.g. Uneconomical to repair, structural damage..." rows="3"></textarea></div>
  </div>
  <div class="modal-footer">
    <button class="btn btn-secondary" onclick="closeModal('condemn-modal')">Cancel</button>
    <button class="btn btn-danger" onclick="saveCondemn()"><i class="fas fa-ban"></i> Condemn Machine</button>
  </div>
</div>
</div>

<!-- REPAIR MODAL -->
<div class="modal-overlay" id="repair-modal">
<div class="modal modal-lg">
  <div class="modal-header"><span class="modal-title" id="repair-modal-title">Log Repair</span><button class="modal-close" onclick="closeModal('repair-modal')"><i class="fas fa-times"></i></button></div>
  <div class="modal-body">
    <div class="form-grid">
      <div class="form-group"><label>Date *</label><input type="date" id="r-date"></div>
      <div class="form-group"><label>Machine Number *</label><select id="r-machine"><option value="">Select machine...</option></select></div>
      <div class="form-group span2"><label>Problem Description *</label><textarea id="r-problem" placeholder="Describe the issue (Hindi or English)..." rows="2"></textarea></div>
      <div class="form-group"><label>Complaint Category</label><select id="r-complaint"><option value="">Select...</option></select></div>
      <div class="form-group"><label>Repair Status *</label><select id="r-status" onchange="onRepairStatusChange()"><option>Open</option><option>In Progress</option><option>Awaiting Parts</option><option>Sent to External Agency</option><option>Completed</option></select></div>

      <div class="form-group span2">
        <label>Performed By *</label>
        <div class="radio-group">
          <label><input type="radio" name="r-by" value="technician" checked onchange="toggleRepairBy()"> In-house Technician</label>
          <label><input type="radio" name="r-by" value="agency" onchange="toggleRepairBy()"> External Agency</label>
        </div>
      </div>
      <div id="r-technician-group" class="form-group span2"><label>Technician</label><select id="r-technician"><option value="">Select...</option></select></div>
      <div id="r-agency-group" style="display:none;grid-column:span 2;">
        <div class="form-grid">
          <div class="form-group span2"><label>Agency</label><select id="r-agency"><option value="">Select...</option></select></div>
          <div class="form-group"><label>Date Sent</label><input type="date" id="r-sent"></div>
          <div class="form-group"><label>Expected Return</label><input type="date" id="r-expected"></div>
          <div class="form-group"><label>Actual Return</label><input type="date" id="r-returned"></div>
          <div class="form-group"><label>Work Done by Agency</label><textarea id="r-agency-work" rows="2"></textarea></div>
        </div>
      </div>

      <div class="form-group"><label>Repair Action</label><select id="r-action"><option value="">Select...</option></select></div>
      <div class="form-group"><label>Action Notes</label><input id="r-action-notes" placeholder="Additional detail..."></div>

      <div id="r-awaiting-group" class="form-group span2" style="display:none"><label>Which Part Are We Waiting For?</label><select id="r-awaiting-part"><option value="">Select part...</option></select></div>
      <div id="r-completed-group" class="form-group span2" style="display:none"><label>Completed Date</label><input type="date" id="r-completed-date"></div>

      <div class="form-group span2">
        <label>Parts Used (up to 6)</label>
        <div class="parts-header"><span>Part</span><span>Qty</span><span></span></div>
        <div id="r-parts-rows"></div>
        <button type="button" class="btn btn-secondary btn-sm" onclick="addPartRow('r-parts-rows')" style="margin-top:6px"><i class="fas fa-plus"></i> Add Part</button>
      </div>
      <div class="form-group span2"><label>Notes / Remarks</label><textarea id="r-notes" rows="2" placeholder="Additional info or parts beyond 6..."></textarea></div>
    </div>
  </div>
  <div class="modal-footer">
    <button class="btn btn-secondary" onclick="closeModal('repair-modal')">Cancel</button>
    <button class="btn btn-primary" onclick="saveRepair()">Save Repair</button>
  </div>
</div>
</div>

<!-- MAINTENANCE MODAL -->
<div class="modal-overlay" id="maintenance-modal">
<div class="modal modal-lg">
  <div class="modal-header"><span class="modal-title">Log Maintenance</span><button class="modal-close" onclick="closeModal('maintenance-modal')"><i class="fas fa-times"></i></button></div>
  <div class="modal-body">
    <div class="form-grid">
      <div class="form-group"><label>Date *</label><input type="date" id="mt-date"></div>
      <div class="form-group"><label>Maintenance Type *</label><select id="mt-type"><option value="">Select...</option></select></div>
      <div class="form-group span2">
        <label>Entry Mode *</label>
        <div class="radio-group">
          <label><input type="radio" name="mt-mode" value="machine" checked onchange="toggleMaintMode()"> Per Machine</label>
          <label><input type="radio" name="mt-mode" value="floor_line" onchange="toggleMaintMode()"> Per Floor / Line</label>
        </div>
      </div>
      <div id="mt-machine-group" class="form-group span2">
        <label>Machine(s) — hold Ctrl/Cmd to select multiple</label>
        <select id="mt-machines" multiple style="height:140px;"></select>
      </div>
      <div id="mt-floor-group" style="display:none;grid-column:span 2;">
        <div class="form-grid">
          <div class="form-group"><label>Floor</label><select id="mt-floor" onchange="populateLinesInForm('mt-line','mt-floor')"><option value="">Select...</option></select></div>
          <div class="form-group"><label>Line (optional)</label><select id="mt-line"><option value="">All lines</option></select></div>
        </div>
      </div>
      <div class="form-group span2"><label>Done By</label><select id="mt-technician"><option value="">Select...</option></select></div>
      <div class="form-group span2">
        <label>Parts Used (up to 6)</label>
        <div class="parts-header"><span>Part</span><span>Qty</span><span></span></div>
        <div id="mt-parts-rows"></div>
        <button type="button" class="btn btn-secondary btn-sm" onclick="addPartRow('mt-parts-rows')" style="margin-top:6px"><i class="fas fa-plus"></i> Add Part</button>
      </div>
      <div class="form-group span2"><label>Notes</label><textarea id="mt-notes" rows="2"></textarea></div>
    </div>
  </div>
  <div class="modal-footer">
    <button class="btn btn-secondary" onclick="closeModal('maintenance-modal')">Cancel</button>
    <button class="btn btn-primary" onclick="saveMaintenance()">Save</button>
  </div>
</div>
</div>

<!-- CONFIRM MODAL -->
<div class="modal-overlay" id="confirm-modal">
<div class="modal" style="max-width:400px;">
  <div class="modal-body" style="text-align:center;padding:32px 24px;">
    <i class="fas fa-triangle-exclamation" style="font-size:2.5rem;color:var(--red);margin-bottom:16px;display:block;"></i>
    <h3 style="margin-bottom:8px;" id="confirm-title">Confirm Delete</h3>
    <p style="color:var(--text2);margin-bottom:24px;" id="confirm-msg">Are you sure? This cannot be undone.</p>
    <div style="display:flex;gap:10px;justify-content:center;">
      <button class="btn btn-secondary" onclick="closeModal('confirm-modal')">Cancel</button>
      <button class="btn btn-danger" id="confirm-ok">Delete</button>
    </div>
  </div>
</div>
</div>

<!-- MASTER ITEM MODAL -->
<div class="modal-overlay" id="master-modal">
<div class="modal" style="max-width:480px;">
  <div class="modal-header"><span class="modal-title" id="master-modal-title">Add Item</span><button class="modal-close" onclick="closeModal('master-modal')"><i class="fas fa-times"></i></button></div>
  <div class="modal-body">
    <div id="master-modal-fields"></div>
  </div>
  <div class="modal-footer">
    <button class="btn btn-secondary" onclick="closeModal('master-modal')">Cancel</button>
    <button class="btn btn-primary" onclick="saveMasterItem()">Save</button>
  </div>
</div>
</div>

<!-- TOAST & LOADER -->
<div class="toast" id="toast"><i class="fas fa-check-circle" id="toast-icon"></i><span id="toast-msg"></span></div>
<div class="loader" id="loader"><div class="spinner"></div></div>

<script>
// ===================== INIT =====================
const SB_URL = 'https://hpakeryiqyiuokdyrgly.supabase.co';
const SB_KEY = 'sb_publishable_9qC7lY18Vl3M6G01J3Mv1A_ItRh9-fv';
let sb;
try { sb = window.supabase.createClient(SB_URL, SB_KEY); } catch(e) { showConnError('Failed to init Supabase: ' + e.message); }

// ===================== STATE =====================
let DATA = { machines:[], repairs:[], maintenance:[], masters:{} };
let editingId = { machine:null, repair:null, master:null };
let currentMasterTab = null;
let statusChart = null;
let currentReportTab = 'rep-repair';

// ===================== UTILS =====================
function $(id){ return document.getElementById(id); }
function show(id){ $(id).style.display=''; }
function hide(id){ $(id).style.display='none'; }
function loading(on){ $('loader').classList.toggle('show',on); }

function toast(msg, type='success'){
  const t=$('toast'), icon=$('toast-icon'), m=$('toast-msg');
  t.className='toast '+(type==='error'?'error':'success');
  icon.className='fas fa-'+(type==='error'?'circle-xmark':'check-circle');
  m.textContent=msg;
  t.classList.add('show');
  setTimeout(()=>t.classList.remove('show'),3200);
}

function showConnError(msg){
  const el=$('conn-error');
  el.style.display='block';
  el.innerHTML='<i class="fas fa-triangle-exclamation"></i> <strong>Connection Error:</strong> '+msg;
}

function openModal(id){ $(id).classList.add('open'); }
function closeModal(id){ $(id).classList.remove('open'); }

function confirm_(title, msg, cb){
  $('confirm-title').textContent=title;
  $('confirm-msg').textContent=msg;
  $('confirm-ok').onclick=()=>{ closeModal('confirm-modal'); cb(); };
  openModal('confirm-modal');
}

function fmtDate(d){ if(!d)return'–'; return new Date(d+'T00:00:00').toLocaleDateString('en-IN',{day:'2-digit',month:'short',year:'numeric'}); }
function today(){ return new Date().toISOString().split('T')[0]; }
function daysAgo(d){ return Math.floor((Date.now()-new Date(d+'T00:00:00').getTime())/86400000); }

function statusBadge(s){
  const map={
    'Active':'badge-active','Under Repair':'badge-repair',
    'Awaiting Parts':'badge-awaiting','Sent for External Repair':'badge-external',
    'Condemned':'badge-condemned','Open':'badge-repair','In Progress':'badge-inprogress',
    'Sent to External Agency':'badge-agency','Completed':'badge-active',
  };
  return `<span class="badge ${map[s]||'badge-gray'}">${s}</span>`;
}

function partsText(parts){
  if(!parts||!parts.length) return '–';
  return parts.map(p=>`${p.part?.name||p.part_name_custom||'?'} ×${p.quantity}`).join(', ');
}

// ===================== NAVIGATION =====================
const PAGE_TITLES = {
  dashboard:'Dashboard', masters:'Masters / Setup', machines:'Machine Registry',
  history:'Machine History', repairs:'Repair Log', maintenance:'Maintenance Log', reports:'Reports'
};
const PAGE_ACTIONS = {
  machines: `<button class="btn btn-primary btn-sm" onclick="openAddMachine()"><i class="fas fa-plus"></i> Add Machine</button>`,
  repairs:  `<button class="btn btn-primary btn-sm" onclick="openAddRepair()"><i class="fas fa-plus"></i> Log Repair</button>`,
  maintenance:`<button class="btn btn-primary btn-sm" onclick="openAddMaintenance()"><i class="fas fa-plus"></i> Log Maintenance</button>`,
};

function nav(page){
  document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'));
  document.querySelectorAll('.nav-item').forEach(n=>n.classList.remove('active'));
  $('page-'+page).classList.add('active');
  $('page-title').textContent = PAGE_TITLES[page]||page;
  $('topbar-actions').innerHTML = PAGE_ACTIONS[page]||'';
  // highlight nav
  const idx={dashboard:0,masters:1,machines:2,repairs:3,maintenance:4,reports:5};
  const items=document.querySelectorAll('.nav-item');
  if(idx[page]!==undefined) items[idx[page]].classList.add('active');
  // close sidebar on mobile
  if(window.innerWidth<=768) $('sidebar').classList.remove('open');
  // load data
  if(page==='dashboard') loadDashboard();
  if(page==='machines') renderMachines();
  if(page==='repairs') renderRepairs();
  if(page==='maintenance') renderMaintenance();
  if(page==='reports'){ setDefaultDates(); loadReports(); }
}

function toggleSidebar(){ $('sidebar').classList.toggle('open'); }

// Close sidebar on overlay click
document.addEventListener('click', e=>{
  if(window.innerWidth<=768 && !e.target.closest('.sidebar') && !e.target.closest('.hamburger'))
    $('sidebar').classList.remove('open');
});

// ===================== SUPABASE HELPERS =====================
async function dbGet(table, query=q=>q){
  const { data, error } = await query(sb.from(table).select('*'));
  if(error) throw error;
  return data||[];
}

// ===================== LOAD ALL MASTERS =====================
async function loadAllMasters(){
  try {
    const [brands,types,models,floors,lines,parts,maint,complaints,actions,techs,agencies] = await Promise.all([
      sb.from('masters_brands').select('*').order('name'),
      sb.from('masters_machine_types').select('*').order('name'),
      sb.from('masters_models').select('*,brand:masters_brands(name)').order('name'),
      sb.from('masters_floors').select('*').order('name'),
      sb.from('masters_lines').select('*,floor:masters_floors(name)').order('name'),
      sb.from('masters_parts').select('*').order('name'),
      sb.from('masters_maintenance_types').select('*').order('name'),
      sb.from('masters_complaint_types').select('*').order('name'),
      sb.from('masters_repair_actions').select('*').order('name'),
      sb.from('masters_technicians').select('*').order('name'),
      sb.from('masters_agencies').select('*').order('name'),
    ]);
    DATA.masters = {
      brands: brands.data||[], types: types.data||[], models: models.data||[],
      floors: floors.data||[], lines: lines.data||[], parts: parts.data||[],
      maint: maint.data||[], complaints: complaints.data||[], actions: actions.data||[],
      techs: techs.data||[], agencies: agencies.data||[]
    };
  } catch(e) { showConnError(e.message); }
}

async function loadMachines(){
  const { data, error } = await sb.from('machines').select(`*,brand:masters_brands(name),machine_type:masters_machine_types(name),model:masters_models(name),floor:masters_floors(name),line:masters_lines(name)`).order('machine_number');
  if(error){ showConnError(e.message); return; }
  DATA.machines = data||[];
}

async function loadRepairs(){
  const { data, error } = await sb.from('repairs').select(`*,machine:machines(machine_number),complaint_type:masters_complaint_types(name),repair_action:masters_repair_actions(name),technician:masters_technicians(name),agency:masters_agencies(name),awaiting_part:masters_parts(name),repair_parts(*,part:masters_parts(name,unit))`).order('repair_date',{ascending:false}).order('created_at',{ascending:false});
  if(error){ showConnError(error.message); return; }
  DATA.repairs = data||[];
}

async function loadMaintenance(){
  const { data, error } = await sb.from('maintenance_logs').select(`*,machine:machines(machine_number),maintenance_type:masters_maintenance_types(name),technician:masters_technicians(name),floor:masters_floors(name),line:masters_lines(name),maintenance_parts(*,part:masters_parts(name,unit))`).order('log_date',{ascending:false}).order('created_at',{ascending:false});
  if(error){ showConnError(error.message); return; }
  DATA.maintenance = data||[];
}

// ===================== DASHBOARD =====================
async function loadDashboard(){
  loading(true);
  try {
    await Promise.all([loadMachines(), loadRepairs()]);
    const machines = DATA.machines, repairs = DATA.repairs;
    const total = machines.length;
    const active = machines.filter(m=>m.status==='Active').length;
    const open = repairs.filter(r=>['Open','In Progress'].includes(r.status)).length;
    const stale = repairs.filter(r=>['Open','In Progress'].includes(r.status) && daysAgo(r.repair_date)>3).length;
    $('s-total').textContent=total; $('s-active').textContent=active;
    $('s-open').textContent=open; $('s-stale').textContent=stale;

    // Chart
    const statCounts = {};
    ['Active','Under Repair','Awaiting Parts','Sent for External Repair','Condemned'].forEach(s=>{ statCounts[s]=machines.filter(m=>m.status===s).length; });
    if(statusChart) statusChart.destroy();
    statusChart = new Chart($('status-chart').getContext('2d'),{
      type:'doughnut',
      data:{labels:Object.keys(statCounts),datasets:[{data:Object.values(statCounts),backgroundColor:['#10B981','#F59E0B','#F97316','#8B5CF6','#94A3B8'],borderWidth:2,borderColor:'#fff'}]},
      options:{responsive:true,plugins:{legend:{position:'bottom',labels:{font:{size:11}}}}}
    });

    // Open repairs list
    const openR = repairs.filter(r=>['Open','In Progress'].includes(r.status)).slice(0,8);
    $('open-repairs-list').innerHTML = openR.length ? `<table style="width:100%;font-size:.8rem;"><thead><tr><th style="padding:6px 8px;text-align:left;color:var(--text2)">Machine</th><th style="padding:6px 8px;text-align:left;color:var(--text2)">Problem</th><th style="padding:6px 8px;text-align:left;color:var(--text2)">By</th><th style="padding:6px 8px;text-align:left;color:var(--text2)">Days</th></tr></thead><tbody>${openR.map(r=>`<tr><td style="padding:6px 8px;font-weight:600">${r.machine?.machine_number||'–'}</td><td style="padding:6px 8px;max-width:150px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${r.problem_description}</td><td style="padding:6px 8px">${r.technician?.name||r.agency?.name||'–'}</td><td style="padding:6px 8px;color:${daysAgo(r.repair_date)>3?'var(--red)':'var(--text)'};font-weight:${daysAgo(r.repair_date)>3?700:400}">${daysAgo(r.repair_date)}d</td></tr>`).join('')}</tbody></table>`
      : '<div class="empty"><i class="fas fa-check-circle"></i><h3>No open repairs</h3></div>';

    // Problem machines
    const thirtyAgo = new Date(); thirtyAgo.setDate(thirtyAgo.getDate()-30);
    const recentR = repairs.filter(r=>new Date(r.repair_date)>=thirtyAgo);
    const mCount = {}; recentR.forEach(r=>{ mCount[r.machine_id]=(mCount[r.machine_id]||0)+1; });
    const top5 = Object.entries(mCount).sort((a,b)=>b[1]-a[1]).slice(0,5);
    $('problem-machines').innerHTML = top5.length ? `<table style="width:100%;font-size:.8rem;"><tbody>${top5.map(([mid,cnt])=>{const m=machines.find(x=>x.id===mid);return m?`<tr><td style="padding:6px 8px;font-weight:600">${m.machine_number}</td><td style="padding:6px 8px;color:var(--text2)">${m.machine_type?.name||''}</td><td style="padding:6px 8px;text-align:right"><span class="badge badge-repair">${cnt} repairs</span></td></tr>`:''}).join('')}</tbody></table>`
      : '<div class="empty"><i class="fas fa-cog"></i><h3>No data yet</h3></div>';

    // External
    const ext = repairs.filter(r=>r.status==='Sent to External Agency');
    $('external-list').innerHTML = ext.length ? `<table style="width:100%;font-size:.8rem;"><tbody>${ext.map(r=>`<tr><td style="padding:6px 8px;font-weight:600">${r.machine?.machine_number||'–'}</td><td style="padding:6px 8px;color:var(--text2)">${r.agency?.name||'–'}</td><td style="padding:6px 8px;color:var(--text3)">${fmtDate(r.agency_date_sent)}</td></tr>`).join('')}</tbody></table>`
      : '<div class="empty"><i class="fas fa-check"></i><h3>None sent out</h3></div>';
  } catch(e){ showConnError(e.message); }
  loading(false);
}

// ===================== MASTERS =====================
const MASTER_CONFIG = [
  { key:'brands', label:'Brands', table:'masters_brands', fields:[{id:'name',label:'Brand Name',required:true}] },
  { key:'types', label:'Machine Types', table:'masters_machine_types', fields:[{id:'name',label:'Type Name',required:true}] },
  { key:'models', label:'Models', table:'masters_models', fields:[{id:'name',label:'Model Name',required:true},{id:'brand_id',label:'Brand',type:'select',sourceKey:'brands'}] },
  { key:'floors', label:'Floors', table:'masters_floors', fields:[{id:'name',label:'Floor Name',required:true}] },
  { key:'lines', label:'Lines', table:'masters_lines', fields:[{id:'name',label:'Line Name',required:true},{id:'floor_id',label:'Floor',type:'select',sourceKey:'floors'}] },
  { key:'parts', label:'Parts', table:'masters_parts', fields:[{id:'name',label:'Part Name',required:true},{id:'unit',label:'Unit (piece/ml/etc)',placeholder:'piece'}] },
  { key:'maint', label:'Maint. Types', table:'masters_maintenance_types', fields:[{id:'name',label:'Maintenance Type',required:true}] },
  { key:'complaints', label:'Complaint Types', table:'masters_complaint_types', fields:[{id:'name',label:'Complaint Type',required:true}] },
  { key:'actions', label:'Repair Actions', table:'masters_repair_actions', fields:[{id:'name',label:'Repair Action',required:true}] },
  { key:'techs', label:'Technicians', table:'masters_technicians', fields:[{id:'name',label:'Full Name',required:true}] },
  { key:'agencies', label:'Agencies', table:'masters_agencies', fields:[{id:'name',label:'Agency Name',required:true},{id:'contact',label:'Contact'}] },
];

async function loadMastersPage(){
  loading(true);
  await loadAllMasters();
  // Build tabs
  const tabsEl=$('master-tabs'), contEl=$('master-tab-contents');
  tabsEl.innerHTML=''; contEl.innerHTML='';
  MASTER_CONFIG.forEach((cfg,i)=>{
    const tab=document.createElement('button');
    tab.className='tab'+(i===0?' active':'');
    tab.textContent=cfg.label;
    tab.onclick=()=>switchMasterTab(cfg.key);
    tabsEl.appendChild(tab);
    const div=document.createElement('div');
    div.id='master-tab-'+cfg.key;
    div.className='tab-content'+(i===0?' active':'');
    div.innerHTML=renderMasterTab(cfg);
    contEl.appendChild(div);
  });
  currentMasterTab=MASTER_CONFIG[0].key;
  loading(false);
}

function switchMasterTab(key){
  currentMasterTab=key;
  document.querySelectorAll('#master-tabs .tab').forEach((t,i)=>t.classList.toggle('active',MASTER_CONFIG[i].key===key));
  document.querySelectorAll('#master-tab-contents .tab-content').forEach(c=>c.classList.remove('active'));
  $('master-tab-'+key).classList.add('active');
  renderMasterTabContent(key);
}

function renderMasterTab(cfg){
  return `<div class="table-wrap">
    <div class="table-header"><span style="font-weight:600">${cfg.label}</span>
    <button class="btn btn-primary btn-sm" onclick="openAddMaster('${cfg.key}')"><i class="fas fa-plus"></i> Add</button></div>
    <div class="table-container"><table><thead><tr>${cfg.fields.map(f=>`<th>${f.label}</th>`).join('')}<th>Actions</th></tr></thead>
    <tbody id="master-tbody-${cfg.key}"></tbody></table></div></div>`;
}

function renderMasterTabContent(key){
  const cfg=MASTER_CONFIG.find(c=>c.key===key);
  const items=DATA.masters[key]||[];
  const tbody=$('master-tbody-'+key);
  if(!tbody)return;
  if(!items.length){ tbody.innerHTML=`<tr><td colspan="${cfg.fields.length+1}"><div class="empty"><i class="fas fa-list"></i><h3>No items yet</h3></div></td></tr>`; return; }
  tbody.innerHTML=items.map(item=>`<tr>
    ${cfg.fields.map(f=>{
      if(f.type==='select') return `<td>${item[f.sourceKey]?.name||'–'}</td>`;
      return `<td>${item[f.id]||'–'}</td>`;
    }).join('')}
    <td><div class="actions-cell">
      <button class="btn-icon" onclick="openEditMaster('${key}','${item.id}')"><i class="fas fa-edit"></i></button>
      <button class="btn-icon" onclick="deleteMasterItem('${key}','${item.id}')"><i class="fas fa-trash"></i></button>
    </div></td>
  </tr>`).join('');
}

function openAddMaster(key){
  editingId.master=null;
  const cfg=MASTER_CONFIG.find(c=>c.key===key);
  $('master-modal-title').textContent='Add '+cfg.label.replace(/s$/,'');
  $('master-modal-fields').innerHTML=buildMasterFields(cfg, {});
  openModal('master-modal');
  $('master-modal-fields')._cfg=cfg;
}

function openEditMaster(key, id){
  const cfg=MASTER_CONFIG.find(c=>c.key===key);
  const item=(DATA.masters[key]||[]).find(i=>i.id===id);
  if(!item)return;
  editingId.master={key,id};
  $('master-modal-title').textContent='Edit '+cfg.label.replace(/s$/,'');
  $('master-modal-fields').innerHTML=buildMasterFields(cfg, item);
  openModal('master-modal');
  $('master-modal-fields')._cfg=cfg;
}

function buildMasterFields(cfg, item){
  return cfg.fields.map(f=>{
    if(f.type==='select'){
      const opts=(DATA.masters[f.sourceKey]||[]).map(o=>`<option value="${o.id}" ${item[f.id]===o.id?'selected':''}>${o.name}</option>`).join('');
      return `<div class="form-group" style="margin-bottom:12px;"><label>${f.label}</label><select id="mf-${f.id}"><option value="">Select...</option>${opts}</select></div>`;
    }
    return `<div class="form-group" style="margin-bottom:12px;"><label>${f.label}${f.required?' *':''}</label><input id="mf-${f.id}" value="${item[f.id]||''}" placeholder="${f.placeholder||''}"></div>`;
  }).join('');
}

async function saveMasterItem(){
  const container=$('master-modal-fields');
  const key=editingId.master?.key||currentMasterTab;
  const cfg=MASTER_CONFIG.find(c=>c.key===key);
  const payload={};
  for(const f of cfg.fields){
    const el=$('mf-'+f.id);
    if(!el)continue;
    if(f.required&&!el.value.trim()){ toast('Please fill required fields','error'); return; }
    payload[f.id]=el.value.trim()||null;
  }
  loading(true);
  try {
    if(editingId.master){
      await sb.from(cfg.table).update(payload).eq('id',editingId.master.id);
      toast(cfg.label+' updated');
    } else {
      await sb.from(cfg.table).insert(payload);
      toast('Added to '+cfg.label);
    }
    closeModal('master-modal');
    await loadAllMasters();
    renderMasterTabContent(key);
  } catch(e){ toast(e.message,'error'); }
  loading(false);
}

async function deleteMasterItem(key, id){
  const cfg=MASTER_CONFIG.find(c=>c.key===key);
  confirm_('Delete Item','Are you sure you want to delete this item?', async()=>{
    loading(true);
    try { await sb.from(cfg.table).delete().eq('id',id); toast('Deleted'); await loadAllMasters(); renderMasterTabContent(key); }
    catch(e){ toast(e.message,'error'); }
    loading(false);
  });
}

// ===================== MACHINE REGISTRY =====================
function populateSelect(elId, items, valueKey='id', labelKey='name', emptyLabel='Select...'){
  const el=$(elId); if(!el)return;
  el.innerHTML=`<option value="">${emptyLabel}</option>`+items.map(i=>`<option value="${i[valueKey]}">${i[labelKey]}</option>`).join('');
}

function populateLinesInForm(lineElId, floorElId){
  const floorId=$(floorElId)?.value;
  const lines=(DATA.masters.lines||[]).filter(l=>!floorId||l.floor_id===floorId);
  populateSelect(lineElId, lines);
}

function openAddMachine(){
  editingId.machine=null;
  $('machine-modal-title').textContent='Add Machine';
  $('machine-modal').querySelectorAll('input,select,textarea').forEach(el=>el.value='');
  $('m-status').value='Active';
  populateSelect('m-brand', DATA.masters.brands);
  populateSelect('m-type', DATA.masters.types);
  populateSelect('m-model', DATA.masters.models);
  populateSelect('m-floor', DATA.masters.floors);
  populateSelect('m-line', DATA.masters.lines);
  openModal('machine-modal');
}

function openEditMachine(id){
  const m=DATA.machines.find(x=>x.id===id); if(!m)return;
  editingId.machine=id;
  $('machine-modal-title').textContent='Edit Machine';
  populateSelect('m-brand', DATA.masters.brands);
  populateSelect('m-type', DATA.masters.types);
  populateSelect('m-model', DATA.masters.models);
  populateSelect('m-floor', DATA.masters.floors);
  populateLinesInForm('m-line','m-floor');
  $('m-number').value=m.machine_number||'';
  $('m-status').value=m.status||'Active';
  $('m-brand').value=m.brand_id||'';
  $('m-type').value=m.machine_type_id||'';
  $('m-model').value=m.model_id||'';
  $('m-floor').value=m.floor_id||'';
  $('m-line').value=m.line_id||'';
  $('m-date').value=m.purchase_date||'';
  $('m-notes').value=m.notes||'';
  openModal('machine-modal');
}

async function saveMachine(){
  const num=$('m-number').value.trim();
  if(!num){ toast('Machine number is required','error'); return; }
  const payload={
    machine_number:num, status:$('m-status').value,
    brand_id:$('m-brand').value||null, machine_type_id:$('m-type').value||null,
    model_id:$('m-model').value||null, floor_id:$('m-floor').value||null,
    line_id:$('m-line').value||null, purchase_date:$('m-date').value||null,
    notes:$('m-notes').value||null, updated_at:new Date().toISOString()
  };
  loading(true);
  try {
    if(editingId.machine){ await sb.from('machines').update(payload).eq('id',editingId.machine); toast('Machine updated'); }
    else { await sb.from('machines').insert(payload); toast('Machine added'); }
    closeModal('machine-modal');
    await loadMachines();
    renderMachines();
  } catch(e){ toast(e.message,'error'); }
  loading(false);
}

function openCondemn(id){
  $('condemn-id').value=id;
  $('condemn-date').value=today();
  $('condemn-reason').value='';
  openModal('condemn-modal');
}

async function saveCondemn(){
  const id=$('condemn-id').value;
  const reason=$('condemn-reason').value.trim();
  const date=$('condemn-date').value;
  if(!reason){ toast('Please enter a reason','error'); return; }
  loading(true);
  try {
    await sb.from('machines').update({status:'Condemned',condemned_date:date||null,condemned_reason:reason,updated_at:new Date().toISOString()}).eq('id',id);
    closeModal('condemn-modal'); toast('Machine condemned'); await loadMachines(); renderMachines();
  } catch(e){ toast(e.message,'error'); }
  loading(false);
}

async function deleteMachine(id){
  confirm_('Delete Machine','Delete this machine and all its repair/maintenance records?', async()=>{
    loading(true);
    try { await sb.from('machines').delete().eq('id',id); toast('Machine deleted'); await loadMachines(); renderMachines(); }
    catch(e){ toast(e.message,'error'); }
    loading(false);
  });
}

function renderMachines(){
  const search=$('machine-search')?.value.toLowerCase()||'';
  const floorF=$('machine-floor-filter')?.value||'';
  const statusF=$('machine-status-filter')?.value||'';
  // Populate floor filter
  const ff=$('machine-floor-filter');
  if(ff){
    const cur=ff.value;
    ff.innerHTML='<option value="">All Floors</option>'+(DATA.masters.floors||[]).map(f=>`<option value="${f.id}">${f.name}</option>`).join('');
    ff.value=cur;
  }
  let list=[...DATA.machines];
  if(search) list=list.filter(m=>(m.machine_number||'').toLowerCase().includes(search)||(m.brand?.name||'').toLowerCase().includes(search));
  if(floorF) list=list.filter(m=>m.floor_id===floorF);
  if(statusF) list=list.filter(m=>m.status===statusF);
  const tbody=$('machines-tbody');
  if(!list.length){ tbody.innerHTML=`<tr><td colspan="8"><div class="empty"><i class="fas fa-industry"></i><h3>No machines found</h3><p>Add a machine or adjust filters</p></div></td></tr>`; return; }
  tbody.innerHTML=list.map(m=>`<tr>
    <td><a href="#" style="color:var(--blue);font-weight:600;text-decoration:none;" onclick="openHistory('${m.id}');return false;">${m.machine_number}</a></td>
    <td>${m.brand?.name||'–'}</td>
    <td>${m.machine_type?.name||'–'}</td>
    <td>${m.floor?.name||'–'}</td>
    <td>${m.line?.name||'–'}</td>
    <td>${fmtDate(m.purchase_date)}</td>
    <td>${statusBadge(m.status)}</td>
    <td><div class="actions-cell">
      <button class="btn-icon" title="Edit" onclick="openEditMachine('${m.id}')"><i class="fas fa-edit"></i></button>
      ${m.status!=='Condemned'?`<button class="btn-icon" title="Condemn" onclick="openCondemn('${m.id}')"><i class="fas fa-ban"></i></button>`:''}
      <button class="btn-icon" title="Delete" onclick="deleteMachine('${m.id}')"><i class="fas fa-trash"></i></button>
    </div></td>
  </tr>`).join('');
}

// ===================== MACHINE HISTORY =====================
async function openHistory(machineId){
  loading(true);
  nav('history');
  try {
    const m=DATA.machines.find(x=>x.id===machineId);
    if(m){
      $('history-machine-card').innerHTML=`
        <div style="display:flex;justify-content:space-between;align-items:flex-start;flex-wrap:wrap;gap:12px;">
          <div>
            <div style="font-size:1.5rem;font-weight:700;color:var(--navy)">${m.machine_number}</div>
            <div style="color:var(--text2);margin-top:4px;">${m.brand?.name||''} ${m.machine_type?.name||''} ${m.model?.name?'/ '+m.model.name:''}</div>
            <div style="color:var(--text3);font-size:.8rem;margin-top:2px;">${m.floor?.name||''} ${m.line?.name?'→ '+m.line.name:''}</div>
          </div>
          <div style="display:flex;gap:10px;align-items:center;">
            ${statusBadge(m.status)}
            ${m.purchase_date?`<span style="font-size:.8rem;color:var(--text2)">Purchased: ${fmtDate(m.purchase_date)}</span>`:''}
          </div>
        </div>
        ${m.condemned_reason?`<div style="margin-top:12px;padding:10px;background:#fee2e2;border-radius:6px;font-size:.875rem;color:#991b1b;"><strong>Condemnation reason:</strong> ${m.condemned_reason} (${fmtDate(m.condemned_date)})</div>`:''}`;
    }
    const [{ data: repairs }, { data: maint }] = await Promise.all([
      sb.from('repairs').select(`*,complaint_type:masters_complaint_types(name),repair_action:masters_repair_actions(name),technician:masters_technicians(name),agency:masters_agencies(name),repair_parts(*,part:masters_parts(name,unit))`).eq('machine_id',machineId).order('repair_date',{ascending:false}),
      sb.from('maintenance_logs').select(`*,maintenance_type:masters_maintenance_types(name),technician:masters_technicians(name),maintenance_parts(*,part:masters_parts(name,unit))`).eq('machine_id',machineId).order('log_date',{ascending:false})
    ]);
    const items=[
      ...(repairs||[]).map(r=>({...r,_type:'repair',_date:r.repair_date})),
      ...(maint||[]).map(m=>({...m,_type:'maintenance',_date:m.log_date}))
    ].sort((a,b)=>new Date(b._date)-new Date(a._date));

    const tl=$('history-timeline');
    if(!items.length){ tl.innerHTML='<div class="empty"><i class="fas fa-clock-rotate-left"></i><h3>No history yet</h3></div>'; }
    else {
      tl.innerHTML=items.map(item=>{
        if(item._type==='repair'){
          const parts=item.repair_parts||[];
          return `<div class="timeline-item">
            <div class="timeline-icon" style="background:#fee2e2;color:var(--red)"><i class="fas fa-wrench"></i></div>
            <div class="timeline-content">
              <div class="timeline-date">${fmtDate(item._date)} &nbsp; ${statusBadge(item.status)}</div>
              <div class="timeline-title">Repair — ${item.complaint_type?.name||'Issue reported'}</div>
              <div class="timeline-detail">${item.problem_description}</div>
              ${item.repair_action?.name?`<div class="timeline-detail" style="margin-top:4px;"><strong>Action:</strong> ${item.repair_action.name}${item.repair_action_notes?' — '+item.repair_action_notes:''}</div>`:''}
              ${item.technician?.name?`<div class="timeline-detail"><strong>By:</strong> ${item.technician.name}</div>`:''}
              ${item.agency?.name?`<div class="timeline-detail"><strong>Agency:</strong> ${item.agency.name}${item.agency_date_sent?' (sent '+fmtDate(item.agency_date_sent)+')':''}</div>`:''}
              ${parts.length?`<div class="timeline-detail" style="margin-top:4px;"><strong>Parts:</strong> ${partsText(parts)}</div>`:''}
              ${item.notes?`<div class="timeline-detail" style="color:var(--text3)">${item.notes}</div>`:''}
            </div>
          </div>`;
        } else {
          const parts=item.maintenance_parts||[];
          return `<div class="timeline-item">
            <div class="timeline-icon" style="background:#d1fae5;color:var(--green)"><i class="fas fa-screwdriver-wrench"></i></div>
            <div class="timeline-content">
              <div class="timeline-date">${fmtDate(item._date)}</div>
              <div class="timeline-title">Maintenance — ${item.maintenance_type?.name||'Service'}</div>
              ${item.technician?.name?`<div class="timeline-detail"><strong>By:</strong> ${item.technician.name}</div>`:''}
              ${parts.length?`<div class="timeline-detail"><strong>Parts:</strong> ${partsText(parts)}</div>`:''}
              ${item.notes?`<div class="timeline-detail" style="color:var(--text3)">${item.notes}</div>`:''}
            </div>
          </div>`;
        }
      }).join('');
    }
  } catch(e){ showConnError(e.message); }
  loading(false);
}

// ===================== REPAIR LOG =====================
function addPartRow(containerId, partId='', partCustom='', qty=''){
  const c=$(containerId);
  if(c.children.length>=6){ toast('Maximum 6 parts per entry. Use Notes for additional parts.','error'); return; }
  const row=document.createElement('div');
  row.className='parts-row';
  const partOpts=(DATA.masters.parts||[]).map(p=>`<option value="${p.id}" ${p.id===partId?'selected':''}>${p.name} (${p.unit})</option>`).join('');
  row.innerHTML=`<select class="part-select"><option value="">From catalog...</option>${partOpts}</select>
    <input type="number" class="part-qty" value="${qty}" placeholder="Qty" min="0" step="0.5">
    <button type="button" class="btn-icon" onclick="this.parentElement.remove()"><i class="fas fa-times"></i></button>`;
  c.appendChild(row);
}

function getPartsFromRows(containerId){
  return [...$(containerId).querySelectorAll('.parts-row')].map(row=>{
    const sel=row.querySelector('.part-select');
    const qty=row.querySelector('.part-qty');
    if(!qty.value) return null;
    return { part_id: sel.value||null, quantity: parseFloat(qty.value)||0 };
  }).filter(Boolean);
}

function toggleRepairBy(){
  const isAgency=document.querySelector('[name="r-by"]:checked')?.value==='agency';
  $('r-technician-group').style.display=isAgency?'none':'';
  $('r-agency-group').style.display=isAgency?'':'none';
}

function onRepairStatusChange(){
  const s=$('r-status').value;
  $('r-awaiting-group').style.display=s==='Awaiting Parts'?'':'none';
  $('r-completed-group').style.display=s==='Completed'?'':'none';
}

function openAddRepair(){
  editingId.repair=null;
  $('repair-modal-title').textContent='Log Repair';
  $('repair-modal').querySelectorAll('input:not([type=radio]),select,textarea').forEach(el=>el.value='');
  document.querySelector('[name="r-by"][value="technician"]').checked=true;
  toggleRepairBy(); onRepairStatusChange();
  $('r-date').value=today();
  populateSelect('r-machine', DATA.machines, 'id','machine_number','Select machine...');
  populateSelect('r-technician', DATA.masters.techs, 'id','name','Select...');
  populateSelect('r-agency', DATA.masters.agencies, 'id','name','Select...');
  populateSelect('r-complaint', DATA.masters.complaints, 'id','name','Select...');
  populateSelect('r-action', DATA.masters.actions, 'id','name','Select...');
  populateSelect('r-awaiting-part', DATA.masters.parts, 'id','name','Select part...');
  $('r-parts-rows').innerHTML='';
  addPartRow('r-parts-rows');
  openModal('repair-modal');
}

async function openEditRepair(id){
  const r=DATA.repairs.find(x=>x.id===id); if(!r)return;
  editingId.repair=id;
  $('repair-modal-title').textContent='Edit Repair';
  populateSelect('r-machine', DATA.machines, 'id','machine_number','Select machine...');
  populateSelect('r-technician', DATA.masters.techs, 'id','name','Select...');
  populateSelect('r-agency', DATA.masters.agencies, 'id','name','Select...');
  populateSelect('r-complaint', DATA.masters.complaints, 'id','name','Select...');
  populateSelect('r-action', DATA.masters.actions, 'id','name','Select...');
  populateSelect('r-awaiting-part', DATA.masters.parts, 'id','name','Select part...');
  $('r-date').value=r.repair_date||today();
  $('r-machine').value=r.machine_id||'';
  $('r-problem').value=r.problem_description||'';
  $('r-complaint').value=r.complaint_type_id||'';
  $('r-action').value=r.repair_action_id||'';
  $('r-action-notes').value=r.repair_action_notes||'';
  $('r-status').value=r.status||'Open';
  $('r-notes').value=r.notes||'';
  $('r-completed-date').value=r.completed_date||'';
  $('r-awaiting-part').value=r.awaiting_part_id||'';
  const isAgency=r.performed_by_type==='agency';
  document.querySelector(`[name="r-by"][value="${r.performed_by_type||'technician'}"]`).checked=true;
  toggleRepairBy(); onRepairStatusChange();
  $('r-technician').value=r.technician_id||'';
  $('r-agency').value=r.agency_id||'';
  $('r-sent').value=r.agency_date_sent||'';
  $('r-expected').value=r.agency_expected_return||'';
  $('r-returned').value=r.agency_actual_return||'';
  $('r-agency-work').value=r.agency_work_done||'';
  $('r-parts-rows').innerHTML='';
  (r.repair_parts||[]).forEach(p=>addPartRow('r-parts-rows',p.part_id||'','',p.quantity));
  if(!($('r-parts-rows').children.length)) addPartRow('r-parts-rows');
  openModal('repair-modal');
}

async function saveRepair(){
  const machineId=$('r-machine').value;
  const problem=$('r-problem').value.trim();
  if(!machineId||!problem){ toast('Machine and problem description are required','error'); return; }
  const isAgency=document.querySelector('[name="r-by"]:checked')?.value==='agency';
  const status=$('r-status').value;
  const isCompleted=status==='Completed';
  const payload={
    machine_id:machineId, repair_date:$('r-date').value||today(),
    problem_description:problem, complaint_type_id:$('r-complaint').value||null,
    repair_action_id:$('r-action').value||null, repair_action_notes:$('r-action-notes').value||null,
    performed_by_type:isAgency?'agency':'technician',
    technician_id:isAgency?null:($('r-technician').value||null),
    agency_id:isAgency?($('r-agency').value||null):null,
    agency_date_sent:isAgency?($('r-sent').value||null):null,
    agency_expected_return:isAgency?($('r-expected').value||null):null,
    agency_actual_return:isAgency?($('r-returned').value||null):null,
    agency_work_done:isAgency?($('r-agency-work').value||null):null,
    awaiting_part_id:status==='Awaiting Parts'?($('r-awaiting-part').value||null):null,
    status, completed_date:isCompleted?($('r-completed-date').value||today()):null,
    parts_locked:isCompleted, notes:$('r-notes').value||null,
    updated_at:new Date().toISOString()
  };
  loading(true);
  try {
    let repairId=editingId.repair;
    if(repairId){
      await sb.from('repairs').update(payload).eq('id',repairId);
    } else {
      const {data,error}=await sb.from('repairs').insert(payload).select();
      if(error)throw error;
      repairId=data[0].id;
    }
    // Save parts (delete existing, re-insert)
    if(!payload.parts_locked||!editingId.repair){
      await sb.from('repair_parts').delete().eq('repair_id',repairId);
      const parts=getPartsFromRows('r-parts-rows');
      if(parts.length) await sb.from('repair_parts').insert(parts.map(p=>({...p,repair_id:repairId})));
    }
    // Update machine status
    const statusMap={'Open':'Under Repair','In Progress':'Under Repair','Awaiting Parts':'Awaiting Parts','Sent to External Agency':'Sent for External Repair','Completed':'Active'};
    if(statusMap[status]) await sb.from('machines').update({status:statusMap[status],updated_at:new Date().toISOString()}).eq('id',machineId);
    toast(editingId.repair?'Repair updated':'Repair logged');
    closeModal('repair-modal');
    await loadRepairs(); await loadMachines(); renderRepairs();
  } catch(e){ toast(e.message,'error'); }
  loading(false);
}

async function deleteRepair(id){
  confirm_('Delete Repair','Delete this repair record?', async()=>{
    loading(true);
    try { await sb.from('repairs').delete().eq('id',id); toast('Deleted'); await loadRepairs(); renderRepairs(); }
    catch(e){ toast(e.message,'error'); }
    loading(false);
  });
}

function renderRepairs(){
  const search=$('repair-search')?.value.toLowerCase()||'';
  const statusF=$('repair-status-filter')?.value||'';
  const fromF=$('repair-date-from')?.value||'';
  const toF=$('repair-date-to')?.value||'';
  let list=[...DATA.repairs];
  if(search) list=list.filter(r=>(r.machine?.machine_number||'').toLowerCase().includes(search));
  if(statusF) list=list.filter(r=>r.status===statusF);
  if(fromF) list=list.filter(r=>r.repair_date>=fromF);
  if(toF) list=list.filter(r=>r.repair_date<=toF);
  const tbody=$('repairs-tbody');
  if(!list.length){ tbody.innerHTML=`<tr><td colspan="7"><div class="empty"><i class="fas fa-wrench"></i><h3>No repairs found</h3></div></td></tr>`; return; }
  tbody.innerHTML=list.map(r=>`<tr>
    <td><strong>${r.machine?.machine_number||'–'}</strong></td>
    <td>${fmtDate(r.repair_date)}</td>
    <td style="max-width:200px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;" title="${r.problem_description}">${r.problem_description}</td>
    <td>${r.complaint_type?.name||'–'}</td>
    <td>${r.technician?.name||r.agency?.name||'–'}</td>
    <td>${statusBadge(r.status)}</td>
    <td><div class="actions-cell">
      <button class="btn-icon" title="Edit" onclick="openEditRepair('${r.id}')"><i class="fas fa-edit"></i></button>
      <button class="btn-icon" title="Delete" onclick="deleteRepair('${r.id}')"><i class="fas fa-trash"></i></button>
    </div></td>
  </tr>`).join('');
}

// ===================== MAINTENANCE =====================
function toggleMaintMode(){
  const isMachine=document.querySelector('[name="mt-mode"]:checked')?.value==='machine';
  $('mt-machine-group').style.display=isMachine?'':'none';
  $('mt-floor-group').style.display=isMachine?'none':'';
}

function openAddMaintenance(){
  $('maintenance-modal').querySelectorAll('input:not([type=radio]),select,textarea').forEach(el=>el.value='');
  document.querySelector('[name="mt-mode"][value="machine"]').checked=true;
  toggleMaintMode();
  $('mt-date').value=today();
  const machOpts=(DATA.machines||[]).map(m=>`<option value="${m.id}">${m.machine_number}${m.floor?.name?' — '+m.floor.name:''}</option>`).join('');
  $('mt-machines').innerHTML=machOpts;
  populateSelect('mt-type', DATA.masters.maint, 'id','name','Select...');
  populateSelect('mt-technician', DATA.masters.techs, 'id','name','Select...');
  populateSelect('mt-floor', DATA.masters.floors, 'id','name','Select...');
  populateSelect('mt-line', DATA.masters.lines, 'id','name','All lines');
  $('mt-parts-rows').innerHTML='';
  addPartRow('mt-parts-rows');
  openModal('maintenance-modal');
}

async function saveMaintenance(){
  const mode=document.querySelector('[name="mt-mode"]:checked')?.value;
  const typeId=$('mt-type').value;
  if(!typeId){ toast('Please select maintenance type','error'); return; }
  const techId=$('mt-technician').value||null;
  const notes=$('mt-notes').value||null;
  const logDate=$('mt-date').value||today();
  const parts=getPartsFromRows('mt-parts-rows');
  loading(true);
  try {
    let logIds=[];
    if(mode==='machine'){
      const selected=[...$('mt-machines').selectedOptions].map(o=>o.value);
      if(!selected.length){ toast('Please select at least one machine','error'); loading(false); return; }
      for(const machId of selected){
        const {data,error}=await sb.from('maintenance_logs').insert({log_date:logDate,entry_mode:'machine',machine_id:machId,maintenance_type_id:typeId,technician_id:techId,notes}).select();
        if(error)throw error;
        logIds.push(data[0].id);
      }
    } else {
      const floorId=$('mt-floor').value||null;
      const lineId=$('mt-line').value||null;
      const {data,error}=await sb.from('maintenance_logs').insert({log_date:logDate,entry_mode:'floor_line',floor_id:floorId,line_id:lineId,maintenance_type_id:typeId,technician_id:techId,notes}).select();
      if(error)throw error;
      logIds.push(data[0].id);
    }
    for(const logId of logIds){
      if(parts.length) await sb.from('maintenance_parts').insert(parts.map(p=>({...p,maintenance_log_id:logId})));
    }
    toast('Maintenance logged ('+logIds.length+' record'+(logIds.length>1?'s':'')+')');
    closeModal('maintenance-modal');
    await loadMaintenance(); renderMaintenance();
  } catch(e){ toast(e.message,'error'); }
  loading(false);
}

async function deleteMaintenance(id){
  confirm_('Delete Maintenance Record','Delete this maintenance record?', async()=>{
    loading(true);
    try { await sb.from('maintenance_logs').delete().eq('id',id); toast('Deleted'); await loadMaintenance(); renderMaintenance(); }
    catch(e){ toast(e.message,'error'); }
    loading(false);
  });
}

function renderMaintenance(){
  const modeF=$('maint-mode-filter')?.value||'';
  const fromF=$('maint-date-from')?.value||'';
  const toF=$('maint-date-to')?.value||'';
  let list=[...DATA.maintenance];
  if(modeF) list=list.filter(m=>m.entry_mode===modeF);
  if(fromF) list=list.filter(m=>m.log_date>=fromF);
  if(toF) list=list.filter(m=>m.log_date<=toF);
  const tbody=$('maintenance-tbody');
  if(!list.length){ tbody.innerHTML=`<tr><td colspan="6"><div class="empty"><i class="fas fa-calendar-check"></i><h3>No maintenance records</h3></div></td></tr>`; return; }
  tbody.innerHTML=list.map(m=>{
    const who=m.entry_mode==='machine'?`<strong>${m.machine?.machine_number||'–'}</strong>`:`${m.floor?.name||'–'}${m.line?.name?' → '+m.line.name:''}`;
    const parts=m.maintenance_parts||[];
    return `<tr>
      <td>${who}</td>
      <td>${fmtDate(m.log_date)}</td>
      <td>${m.maintenance_type?.name||'–'}</td>
      <td>${m.technician?.name||'–'}</td>
      <td style="font-size:.8rem;max-width:180px;">${partsText(parts)}</td>
      <td><div class="actions-cell">
        <button class="btn-icon" onclick="deleteMaintenance('${m.id}')"><i class="fas fa-trash"></i></button>
      </div></td>
    </tr>`;
  }).join('');
}

// ===================== REPORTS =====================
function switchReport(id){
  currentReportTab=id;
  document.querySelectorAll('.reports .tab').forEach(t=>t.classList.remove('active'));
  document.querySelectorAll('#page-reports .tab-content').forEach(c=>c.classList.remove('active'));
  $(id).classList.add('active');
  document.querySelectorAll('#page-reports .tabs .tab').forEach(t=>{
    t.classList.toggle('active',t.textContent.toLowerCase().replace(/\s/g,'')===id.replace('rep-','').replace('-',''));
  });
}

function setDefaultDates(){
  const now=new Date();
  const from=new Date(now.getFullYear(),now.getMonth(),1).toISOString().split('T')[0];
  const to=now.toISOString().split('T')[0];
  if(!$('rep-from').value) $('rep-from').value=from;
  if(!$('rep-to').value) $('rep-to').value=to;
}

async function loadReports(){
  loading(true);
  const from=$('rep-from').value;
  const to=$('rep-to').value;
  await Promise.all([loadRepairs(), loadMaintenance(), loadMachines()]);
  const repairs=DATA.repairs.filter(r=>(!from||r.repair_date>=from)&&(!to||r.repair_date<=to));
  const maint=DATA.maintenance.filter(m=>(!from||m.log_date>=from)&&(!to||m.log_date<=to));

  // Repair Report
  $('rep-repair-body').innerHTML=repairs.map(r=>`<tr>
    <td><strong>${r.machine?.machine_number||'–'}</strong></td><td>${fmtDate(r.repair_date)}</td>
    <td style="max-width:200px">${r.problem_description}</td>
    <td>${r.complaint_type?.name||'–'}</td>
    <td>${r.technician?.name||r.agency?.name||'–'}</td>
    <td style="font-size:.8rem">${partsText(r.repair_parts)}</td>
    <td>${statusBadge(r.status)}</td>
  </tr>`).join('')||'<tr><td colspan="7" style="text-align:center;padding:20px;color:var(--text3)">No records in this period</td></tr>';

  // Maintenance Report
  $('rep-maint-body').innerHTML=maint.map(m=>`<tr>
    <td>${m.entry_mode==='machine'?`<strong>${m.machine?.machine_number||'–'}</strong>`:`${m.floor?.name||'–'}${m.line?.name?' → '+m.line.name:''}`}</td>
    <td>${fmtDate(m.log_date)}</td><td>${m.maintenance_type?.name||'–'}</td>
    <td>${m.technician?.name||'–'}</td><td style="font-size:.8rem">${partsText(m.maintenance_parts)}</td>
  </tr>`).join('')||'<tr><td colspan="5" style="text-align:center;padding:20px;color:var(--text3)">No records in this period</td></tr>';

  // Machine Summary
  const machineSummary={};
  DATA.machines.forEach(m=>{ machineSummary[m.id]={machine:m,repairs:0,maintenance:0}; });
  repairs.forEach(r=>{ if(machineSummary[r.machine_id]) machineSummary[r.machine_id].repairs++; });
  maint.filter(m=>m.machine_id).forEach(m=>{ if(machineSummary[m.machine_id]) machineSummary[m.machine_id].maintenance++; });
  $('rep-machine-body').innerHTML=Object.values(machineSummary).map(s=>`<tr>
    <td><strong>${s.machine.machine_number}</strong></td>
    <td>${s.machine.brand?.name||'–'}</td>
    <td>${s.machine.floor?.name||'–'}</td>
    <td>${s.machine.line?.name||'–'}</td>
    <td style="text-align:center">${s.repairs}</td>
    <td style="text-align:center">${s.maintenance}</td>
  </tr>`).join('')||'<tr><td colspan="6" style="text-align:center;padding:20px;color:var(--text3)">No machines</td></tr>';

  // Part Summary
  const partMap={};
  repairs.forEach(r=>(r.repair_parts||[]).forEach(p=>{
    const key=p.part?.name||p.part_name_custom||'Unknown';
    const unit=p.part?.unit||'';
    if(!partMap[key]) partMap[key]={name:key,unit,repair:0,maint:0};
    partMap[key].repair+=parseFloat(p.quantity)||0;
  }));
  maint.forEach(m=>(m.maintenance_parts||[]).forEach(p=>{
    const key=p.part?.name||p.part_name_custom||'Unknown';
    const unit=p.part?.unit||'';
    if(!partMap[key]) partMap[key]={name:key,unit,repair:0,maint:0};
    partMap[key].maint+=parseFloat(p.quantity)||0;
  }));
  const partList=Object.values(partMap).sort((a,b)=>(b.repair+b.maint)-(a.repair+a.maint));
  $('rep-part-body').innerHTML=partList.map(p=>`<tr>
    <td><strong>${p.name}</strong></td><td>${p.unit}</td>
    <td style="text-align:center">${p.repair}</td>
    <td style="text-align:center">${p.maint}</td>
    <td style="text-align:center;font-weight:700">${p.repair+p.maint}</td>
  </tr>`).join('')||'<tr><td colspan="5" style="text-align:center;padding:20px;color:var(--text3)">No parts data in this period</td></tr>';

  // External Repairs
  const ext=DATA.repairs.filter(r=>r.agency_id);
  $('rep-ext-body').innerHTML=ext.map(r=>{
    const days=r.agency_date_sent?daysAgo(r.agency_date_sent):'–';
    return `<tr>
      <td><strong>${r.machine?.machine_number||'–'}</strong></td>
      <td>${r.agency?.name||'–'}</td>
      <td>${fmtDate(r.agency_date_sent)}</td>
      <td>${fmtDate(r.agency_expected_return)}</td>
      <td>${fmtDate(r.agency_actual_return)}</td>
      <td>${typeof days==='number'?days+'d':'–'}</td>
      <td>${statusBadge(r.status)}</td>
    </tr>`;
  }).join('')||'<tr><td colspan="7" style="text-align:center;padding:20px;color:var(--text3)">No external repairs found</td></tr>';

  loading(false);
}

function exportCurrentReport(){
  const tableMap={
    'rep-repair':'rep-repair-body','rep-maintenance':'rep-maint-body',
    'rep-machine-summary':'rep-machine-body','rep-part-summary':'rep-part-body','rep-external':'rep-ext-body'
  };
  const bodyId=Object.values(tableMap)[Object.keys(tableMap).indexOf(currentReportTab)];
  const tbody=$(currentReportTab.replace('rep-','rep-')+'');
  // Find the table
  const table=$(currentReportTab)?.querySelector('table');
  if(!table){ toast('Nothing to export','error'); return; }
  const wb=XLSX.utils.book_new();
  const ws=XLSX.utils.table_to_sheet(table);
  XLSX.utils.book_append_sheet(wb,ws,'Report');
  XLSX.writeFile(wb,'StitchTrack_Report_'+today()+'.xlsx');
  toast('Exported to Excel');
}

// ===================== EXCEL IMPORT =====================
async function handleImport(input){
  const file=input.files[0]; if(!file)return;
  loading(true);
  try {
    const buf=await file.arrayBuffer();
    const wb=XLSX.read(buf);
    const ws=wb.Sheets[wb.SheetNames[0]];
    const rows=XLSX.utils.sheet_to_json(ws,{defval:''});
    if(!rows.length){ toast('No data found in file','error'); loading(false); return; }
    // Expected columns: Machine Number, Brand, Machine Type, Model, Floor, Line, Purchase Date, Notes
    let imported=0, errors=0;
    for(const row of rows){
      const num=(row['Machine Number']||row['machine_number']||'').toString().trim();
      if(!num){errors++;continue;}
      const payload={machine_number:num, status:'Active', notes:(row['Notes']||'').toString()||null};
      // Resolve or create masters
      async function resolveOrCreate(table, key, name){
        if(!name)return null;
        const existing=(DATA.masters[key]||[]).find(i=>i.name.toLowerCase()===name.toLowerCase());
        if(existing)return existing.id;
        const {data,error}=await sb.from(table).insert({name}).select();
        if(error)return null;
        DATA.masters[key]=[...DATA.masters[key],data[0]];
        return data[0].id;
      }
      payload.brand_id=await resolveOrCreate('masters_brands','brands',(row['Brand']||'').toString().trim());
      payload.machine_type_id=await resolveOrCreate('masters_machine_types','types',(row['Machine Type']||row['machine_type']||'').toString().trim());
      payload.model_id=await resolveOrCreate('masters_models','models',(row['Model']||'').toString().trim());
      payload.floor_id=await resolveOrCreate('masters_floors','floors',(row['Floor']||'').toString().trim());
      payload.line_id=await resolveOrCreate('masters_lines','lines',(row['Line']||'').toString().trim());
      const pd=row['Purchase Date']||row['purchase_date']||'';
      if(pd){try{payload.purchase_date=new Date(pd).toISOString().split('T')[0];}catch(e){}}
      try{ await sb.from('machines').insert(payload); imported++; }
      catch(e){ errors++; }
    }
    await loadMachines(); renderMachines();
    toast(`Import done: ${imported} machines added, ${errors} errors`);
  } catch(e){ toast('Import failed: '+e.message,'error'); }
  input.value='';
  loading(false);
}

// ===================== APP INIT =====================
async function init(){
  loading(true);
  try {
    // Test connection
    const {error}=await sb.from('masters_brands').select('id').limit(1);
    if(error) throw error;
    await loadAllMasters();
    await loadMachines();
    await loadRepairs();
    await loadMaintenance();
    loadDashboard();
    // Set up masters page on nav
    document.querySelectorAll('.nav-item')[1].addEventListener('click',()=>setTimeout(loadMastersPage,50));
  } catch(e){
    showConnError('Could not connect to database: '+e.message+'. Please check your internet connection and refresh the page.');
  }
  loading(false);
}

window.addEventListener('DOMContentLoaded', init);
</script>
</body>
</html>
